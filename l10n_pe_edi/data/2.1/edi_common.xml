<?xml version="1.0" encoding="ISO-8859-1"?>
<odoo>
    <data>

        <template id="pe_ubl_2_1_common_line">
            <t xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
               xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
               xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
               xmlns:ccts="urn:un:unece:uncefact:documentation:2"
               xmlns:ds="http://www.w3.org/2000/09/xmldsig#"
               xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2"
               xmlns:qdt="urn:oasis:names:specification:ubl:schema:xsd:QualifiedDatatypes-2"
               xmlns:sac="urn:sunat:names:specification:ubl:peru:schema:xsd:SunatAggregateComponents-1"
               xmlns:udt="urn:un:unece:uncefact:data:specification:UnqualifiedDataTypesSchemaModule:2"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                <t t-set="line" t-value="line_vals['line']"/>
                <cbc:ID t-esc="line_vals['index']"/>
                <cbc:LineExtensionAmount
                        t-att-currencyID="line.currency_id.name"
                        t-esc="format_float(line.price_subtotal)"/>
                <cac:PricingReference>
                    <cac:AlternativeConditionPrice>
                        <cbc:PriceAmount
                                t-att-currencyID="line.currency_id.name"
                                t-esc="format_float(line_vals['tax_details']['unit_total_included'])"/>
                        <cbc:PriceTypeCode
                                t-esc="line_vals['tax_details']['price_unit_type_code']"/>
                    </cac:AlternativeConditionPrice>
                </cac:PricingReference>
                <cac:TaxTotal>
                    <cbc:TaxAmount
                            t-att-currencyID="line.currency_id.name"
                            t-esc="format_float(line_vals['tax_details']['total_included'] - line_vals['tax_details']['total_excluded'])"/>
                        <cac:TaxSubtotal t-foreach="line_vals['tax_details']['taxes']" t-as="tax_res">
                            <cbc:TaxableAmount
                                    t-if="tax_res['l10n_pe_edi_group_code'] != 'ICBPER'"
                                    t-att-currencyID="line.currency_id.name"
                                    t-esc="format_float(tax_res['base'])"/>
                            <cbc:TaxAmount
                                    t-att-currencyID="line.currency_id.name"
                                    t-esc="format_float(tax_res['amount'])"/>
                            <cbc:BaseUnitMeasure
                                    t-if="tax_res['l10n_pe_edi_group_code'] == 'ICBPER'"
                                    t-att-unitCode="line.product_uom_id.l10n_pe_edi_measure_unit_code"
                                    t-esc='int(line.quantity)'/>
                            <cac:TaxCategory>
                                <cbc:Percent
                                        t-if="tax_res['tax_amount_type'] == 'percent'"
                                        t-esc="tax_res['tax_amount']"/>
                                <cbc:PerUnitAmount
                                        t-if="tax_res['tax_amount_type'] == 'fixed'"
                                        t-att-currencyID="line.currency_id.name"
                                        t-esc="tax_res['tax_amount']"/>
                                <cbc:TaxExemptionReasonCode
                                        t-if="tax_res['l10n_pe_edi_group_code'] != 'ICBPER' and line.l10n_pe_edi_affectation_reason"
                                        t-esc="line.l10n_pe_edi_affectation_reason"/>
                                <cac:TaxScheme>
                                    <cbc:ID t-esc="tax_res['l10n_pe_edi_tax_code']"/>
                                    <cbc:Name t-esc="tax_res['l10n_pe_edi_group_code']"/>
                                    <cbc:TaxTypeCode t-esc="tax_res['l10n_pe_edi_international_code']"/>
                                </cac:TaxScheme>
                            </cac:TaxCategory>
                        </cac:TaxSubtotal>
                </cac:TaxTotal>
                <cac:Item>
                    <cbc:Description t-esc="line.name.replace('\n', ' ')"/>
                    <cac:CommodityClassification t-if="line.product_id">
                        <cbc:ItemClassificationCode t-esc="line.product_id.unspsc_code_id.code"/>
                    </cac:CommodityClassification>
                </cac:Item>
                <cac:Price>
                    <cbc:PriceAmount
                            t-att-currencyID="line.currency_id.name"
                            t-esc="format_float(line_vals['tax_details']['unit_total_excluded'])"/>
                </cac:Price>
            </t>
        </template>

        <template id="pe_ubl_2_1_common">
            <t xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
               xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
               xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
               xmlns:ccts="urn:un:unece:uncefact:documentation:2"
               xmlns:ds="http://www.w3.org/2000/09/xmldsig#"
               xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2"
               xmlns:qdt="urn:oasis:names:specification:ubl:schema:xsd:QualifiedDatatypes-2"
               xmlns:sac="urn:sunat:names:specification:ubl:peru:schema:xsd:SunatAggregateComponents-1"
               xmlns:udt="urn:un:unece:uncefact:data:specification:UnqualifiedDataTypesSchemaModule:2"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                <ext:UBLExtensions>
                    <ext:UBLExtension>
                        <ext:ExtensionContent>
                            <ds:Signature
                                    Id="placeholder"
                                    xmlns:ds="http://www.w3.org/2000/09/xmldsig#"/>
                        </ext:ExtensionContent>
                    </ext:UBLExtension>
                </ext:UBLExtensions>
                <cbc:UBLVersionID>2.1</cbc:UBLVersionID>
                <cbc:CustomizationID>2.0</cbc:CustomizationID>
                <cbc:ID t-esc="record.name.replace(' ', '')"/>
                <cbc:IssueDate t-esc="certificate_date"/>
                <cbc:DocumentCurrencyCode t-esc="record.currency_id.name"/>
                <cac:Signature>
                    <cbc:ID>IDSignKG</cbc:ID>
                    <cac:SignatoryParty>
                        <cac:PartyIdentification>
                            <cbc:ID t-esc="record.company_id.vat"/>
                        </cac:PartyIdentification>
                        <cac:PartyName>
                            <cbc:Name t-esc="record.company_id.name.upper()"/>
                        </cac:PartyName>
                    </cac:SignatoryParty>
                    <cac:DigitalSignatureAttachment>
                        <cac:ExternalReference>
                            <cbc:URI>#SignVX</cbc:URI>
                        </cac:ExternalReference>
                    </cac:DigitalSignatureAttachment>
                </cac:Signature>
                <cac:AccountingSupplierParty>
                    <cbc:CustomerAssignedAccountID t-esc="record.company_id.partner_id.vat"/>
                    <cac:Party>
                        <cac:PartyIdentification>
                            <cbc:ID
                                    t-att-schemeID="record.company_id.partner_id.l10n_latam_identification_type_id.l10n_pe_vat_code"
                                    t-esc="record.company_id.partner_id.vat"/>
                        </cac:PartyIdentification>
                        <cac:PartyName>
                            <cbc:Name t-esc="record.company_id.name"/>
                        </cac:PartyName>
                        <cac:PartyLegalEntity>
                            <cbc:RegistrationName t-esc="record.company_id.partner_id.name"/>
                            <cac:RegistrationAddress>
                                <cbc:ID t-esc="record.company_id.partner_id.l10n_pe_district.code"/>
                                <cbc:AddressTypeCode t-esc="record.company_id.l10n_pe_edi_address_type_code"/>
                                <cbc:StreetName
                                        t-if="record.company_id.partner_id.street"
                                        t-esc="record.partner_id.street"/>
                                <cbc:CityName
                                        t-if="record.company_id.partner_id.city_id.name"
                                        t-esc="record.partner_id.city_id.name"/>
                            </cac:RegistrationAddress>
                        </cac:PartyLegalEntity>
                    </cac:Party>
                </cac:AccountingSupplierParty>
                <cac:AccountingCustomerParty>
                    <cbc:AdditionalAccountID t-esc="record.partner_id.l10n_latam_identification_type_id.l10n_pe_vat_code"/>
                    <cac:Party>
                        <cac:PartyIdentification>
                            <cbc:ID
                                    t-att-schemeID="record.partner_id.l10n_latam_identification_type_id.l10n_pe_vat_code"
                                    t-esc="record.partner_id.vat"/>
                        </cac:PartyIdentification>
                        <cac:PartyLegalEntity>
                            <cbc:RegistrationName t-esc="record.partner_id.name"/>
                        </cac:PartyLegalEntity>
                    </cac:Party>
                </cac:AccountingCustomerParty>
                <cac:TaxTotal>
                    <cbc:TaxAmount
                            t-att-currencyID="record.currency_id.name"
                            t-esc="format_float(tax_details['total_taxes'])"/>
                        <cac:TaxSubtotal t-foreach="tax_details['grouped_taxes']" t-as="tax_res">
                            <cbc:TaxableAmount
                                    t-att-currencyID="record.currency_id.name"
                                    t-esc="format_float(tax_res['base'])"/>
                            <cbc:TaxAmount
                                    t-att-currencyID="record.currency_id.name"
                                    t-esc="format_float(tax_res['amount'])"/>
                            <cac:TaxCategory>
                                <cac:TaxScheme>
                                    <cbc:ID t-esc="tax_res['l10n_pe_edi_tax_code']"/>
                                    <cbc:Name t-esc="tax_res['l10n_pe_edi_group_code']"/>
                                    <cbc:TaxTypeCode t-esc="tax_res['l10n_pe_edi_international_code']"/>
                                </cac:TaxScheme>
                            </cac:TaxCategory>
                        </cac:TaxSubtotal>
                </cac:TaxTotal>
            </t>
        </template>

    </data>
</odoo>
